<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= salida.Id ? 'Editar Salida' : 'Nueva Salida' %></title>
  <link rel="stylesheet" href="/estilos.css" />
</head>
<body>
  <main class="contenedor" style="max-width: 1000px; margin: 2rem auto;">
    <h2><%= salida.Id ? 'Editar Salida' : 'Nueva Salida' %></h2>

    <form action="<%= salida.Id ? ('/salidas/editar/' + salida.Id) : '/salidas/nueva' %>" method="POST" class="form-salida">
      <!-- Orden de compra -->
      <label for="orden_de_compra">Orden de Compra:</label>
      <input
        type="number"
        name="orden_de_compra"
        id="orden_de_compra"
        value="<%= salida.orden_de_compra || '' %>"
      />

      <!-- Fecha -->
      <label for="Fecha">Fecha:</label>
      <input
        type="date"
        name="Fecha"
        id="Fecha"
        value="<%= (salida.Fecha ? new Date(salida.Fecha) : new Date()).toISOString().slice(0,10) %>"
        required
      />

      <!-- Cliente -->
      <label for="ClienteId">Cliente:</label>
      <select name="ClienteId" id="ClienteId" required>
        <% (clientes || []).forEach(function(cliente){ %>
          <option value="<%= cliente.Id %>" <%= (salida.ClienteId === cliente.Id) ? 'selected' : '' %>>
            <%= cliente.Nombre %>
          </option>
        <% }) %>
      </select>

      <!-- Producto -->
      <label for="Producto">Producto:</label>

      <!-- Botones de ordenamiento de productos -->
      <div class="orden-productos">
        <button type="button" id="ordenClaveProd" class="btn btn3">Clave ↑/↓</button>
        <button type="button" id="ordenNombreProd" class="btn btn3">Nombre A–Z</button>
      </div>

      <select
        name="Producto"
        id="Producto"
        required
        data-original-producto="<%= salida.Producto || '' %>"
      >
        <option value="">-- Selecciona un producto --</option>
        <% (productos || []).forEach(function(producto){ %>
          <option
            value="<%= producto.Codigo %>"
            data-clave="<%= producto.Codigo %>"
            data-nombre="<%= producto.Nombre %>"
            <%= (salida.Producto === producto.Codigo) ? 'selected' : '' %>
          >
            <%= producto.Nombre %> (<%= producto.Codigo %>)
          </option>
        <% }) %>
      </select>

      <!-- Lote (se llena en el navegador a partir de window.LOTES) -->
      <label for="Lote">Lote:</label>
      <select
        name="Lote"
        id="Lote"
        required
        data-current-lote="<%= salida.Lote || '' %>"
      >
        <option value="">-- Selecciona un lote --</option>
      </select>
      <small id="ayuda-stock" style="display:block;margin-top:.25rem;opacity:.8;"></small>

      <!-- Cantidad -->
      <label for="Cantidad">Cantidad:</label>
      <input
        type="number"
        name="Cantidad"
        id="Cantidad"
        value="<%= salida.Cantidad || '' %>"
        min="1"
        required
      />

      <!-- Precio de venta -->
      <label for="Precio_Venta">Precio Venta:</label>
      <input
        type="number"
        name="Precio_Venta"
        id="Precio_Venta"
        step="0.01"
        value="<%= salida.Precio_Venta || '' %>"
        required
      />

      <!-- Total facturado -->
      <label for="Total_Facturado">Total Facturado:</label>
      <input
        type="number"
        name="Total_Facturado"
        id="Total_Facturado"
        step="0.01"
        value="<%= salida.Total_Facturado || '' %>"
        required
      />

      <!-- Folio de facturación -->
      <label for="Folio_de_Facturacion">Folio de Facturación:</label>
      <input
        type="text"
        name="Folio_de_Facturacion"
        id="Folio_de_Facturacion"
        value="<%= salida.Folio_de_Facturacion || '' %>"
      />

      <div class="botones" style="margin-top:1rem; display:flex; gap:.5rem; flex-wrap:wrap;">
        <button type="submit" class="btn btn-exito">
          <%= salida.Id ? 'Guardar cambios' : 'Registrar Salida' %>
        </button>
        <a href="/salidas" class="btn btn-secundario">Cancelar</a>
      </div>
    </form>
  </main>

  <!-- Ordenamiento dinámico de productos -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const selectProd = document.getElementById('Producto');
      const btnClave   = document.getElementById('ordenClaveProd');
      const btnNombre = document.getElementById('ordenNombreProd');

      if (!selectProd || !btnClave || !btnNombre) return;

      // Guardamos la lista original de options
      const opcionesOriginales = Array.from(selectProd.querySelectorAll('option'));
      let ascClave = true; // alterna asc/desc

      // Ordenar por CLAVE (Codigo) ↑/↓
      btnClave.addEventListener('click', function () {
        const opciones = opcionesOriginales.slice(1); // sin la opción vacía
        opciones.sort((a, b) => {
          const ca = (a.dataset.clave || '').toString();
          const cb = (b.dataset.clave || '').toString();
          return ascClave
            ? ca.localeCompare(cb, 'es', { numeric: true })
            : cb.localeCompare(ca, 'es', { numeric: true });
        });
        ascClave = !ascClave;
        actualizarSelect(opciones);
      });

      // Ordenar por NOMBRE A–Z
      btnNombre.addEventListener('click', function () {
        const opciones = opcionesOriginales.slice(1);
        opciones.sort((a, b) =>
          (a.dataset.nombre || '').localeCompare(b.dataset.nombre || '', 'es')
        );
        actualizarSelect(opciones);
      });

      // Reconstruye el select sin perder el producto seleccionado
      function actualizarSelect(listaOpciones) {
        const valorActual = selectProd.value;
        selectProd.innerHTML = '';
        selectProd.appendChild(opcionesOriginales[0]); // "-- Selecciona un producto --"
        listaOpciones.forEach(opt => selectProd.appendChild(opt));
        selectProd.value = valorActual;
      }
    });
  </script>

  <!-- Exponer datos al JS (sin lógica) -->
  <script>
    // Datos de la salida actual para que el JS calcule max correctamente:
    window.SALIDA = {
      Producto: "<%= salida.Producto || '' %>",
      Lote: "<%= salida.Lote || '' %>",
      // CantidadOriginal es la cantidad ya descontada previamente (si es edición). En nueva = 0.
      CantidadOriginal: <%= Number(salida.Cantidad || 0) %>
    };

    // Lotes disponibles enviados por el servidor
    window.LOTES = <%- JSON.stringify(lotes || []) %>;
  </script>

  <!-- JS externo servido por la app (usa window.SALIDA y window.LOTES) -->
  <script src="/js/form_salida.js"></script>

  <!-- (Opcional) Pequeño helper para mostrar stock -->
  <script>
    // Si quieres mostrar el stock del lote elegido en el <small id="ayuda-stock">
    document.addEventListener('DOMContentLoaded', function(){
      var loteSel = document.getElementById('Lote');
      var prodSel = document.getElementById('Producto');
      var ayuda   = document.getElementById('ayuda-stock');

      function mostrarStock() {
        var codigo = prodSel.value;
        var lote   = (loteSel.selectedOptions[0] || {}).value || '';
        if (!codigo || !lote) { ayuda.textContent = ''; return; }

        var item = (window.LOTES || []).find(function(l){
          return String(l.Producto) === String(codigo) && String(l.Lote) === String(lote);
        });
        if (!item) { ayuda.textContent = ''; return; }

        var base      = Number(item.Stock || 0);
        var mismoProd = String(codigo) === String(window.SALIDA.Producto || '');
        var mismoLote = String(lote)   === String(window.SALIDA.Lote || '');
        var max       = (mismoProd && mismoLote)
                        ? (base + Number(window.SALIDA.CantidadOriginal || 0))
                        : base;

        ayuda.textContent = 'Stock disponible para esta operación: ' + max + ' unidades';
      }

      prodSel.addEventListener('change', mostrarStock);
      loteSel.addEventListener('change', mostrarStock);
      mostrarStock();
    });
  </script>
</body>
</html>
