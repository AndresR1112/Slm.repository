<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= salida.Id ? 'Editar Salida' : 'Nueva Salida' %></title>
  <link rel="stylesheet" href="/estilos.css" />
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body>
  <main class="contenedor" style="max-width: 1000px; margin: 2rem auto;">
    <h2><%= salida.Id ? 'Editar Salida' : 'Nueva Salida' %></h2>

    <form action="<%= salida.Id ? ('/salidas/editar/' + salida.Id) : '/salidas/nueva' %>" method="POST" class="form-salida">
      <!-- Orden de compra -->
      <label for="orden_de_compra">Orden de Compra:</label>
      <input
        type="number"
        name="orden_de_compra"
        id="orden_de_compra"
        value="<%= salida.orden_de_compra || '' %>"
      />

      <!-- Fecha -->
      <label for="Fecha">Fecha:</label>
      <input
        type="date"
        name="Fecha"
        id="Fecha"
        value="<%= (salida.Fecha ? new Date(salida.Fecha) : new Date()).toISOString().slice(0,10) %>"
        required
      />

      <!-- Cliente -->
      <label for="ClienteId">Cliente:</label>
      <select name="ClienteId" id="ClienteId" required>
        <% (clientes || []).forEach(function(cliente){ %>
          <option value="<%= cliente.Id %>" <%= (String(salida.ClienteId) === String(cliente.Id)) ? 'selected' : '' %>>
            <%= cliente.Nombre %>
          </option>
        <% }) %>
      </select>

      <!-- Producto -->
      <label for="Producto">Producto:</label>

      <!-- Botones de ordenamiento de productos -->
      <div class="orden-productos">
        <button type="button" id="ordenClaveProd" class="btn btn3">Clave ↑/↓</button>
        <button type="button" id="ordenNombreProd" class="btn btn3">Nombre A–Z</button>
      </div>

      <select
        name="Producto"
        id="Producto"
        required
      >
        <option value="">-- Selecciona un producto --</option>
        <% (productos || []).forEach(function(producto){ %>
          <option
            value="<%= producto.Codigo %>"
            data-clave="<%= producto.Codigo %>"
            data-nombre="<%= producto.Nombre %>"
            <%= (String(salida.Producto || '') === String(producto.Codigo)) ? 'selected' : '' %>
          >
            <%= producto.Nombre %> (<%= producto.Codigo %>)
          </option>
        <% }) %>
      </select>

      <!-- Lote -->
      <label for="Lote">Lote:</label>
      <select
        name="Lote"
        id="Lote"
        required
      >
        <option value="">-- Selecciona un lote --</option>
      </select>
      <small id="ayuda-stock" style="display:block;margin-top:.25rem;opacity:.8;"></small>

      <!-- Cantidad -->
      <label for="Cantidad">Cantidad:</label>
      <input
        type="number"
        name="Cantidad"
        id="Cantidad"
        value="<%= salida.Cantidad || '' %>"
        min="1"
        required
      />

      <!-- Precio de venta -->
      <label for="Precio_Venta">Precio Venta:</label>
      <input
        type="number"
        name="Precio_Venta"
        id="Precio_Venta"
        step="0.01"
        value="<%= salida.Precio_Venta || '' %>"
        required
      />

      <!-- Total facturado -->
      <label for="Total_Facturado">Total Facturado:</label>
      <input
        type="number"
        name="Total_Facturado"
        id="Total_Facturado"
        step="0.01"
        value="<%= salida.Total_Facturado || '' %>"
        required
      />

      <!-- Folio de facturación -->
      <label for="Folio_de_Facturacion">Folio de Facturación:</label>
      <input
        type="text"
        name="Folio_de_Facturacion"
        id="Folio_de_Facturacion"
        value="<%= salida.Folio_de_Facturacion || '' %>"
      />

      <div class="botones" style="margin-top:1rem; display:flex; gap:.5rem; flex-wrap:wrap;">
        <button type="submit" class="btn btn-exito">
          <%= salida.Id ? 'Guardar cambios' : 'Registrar Salida' %>
        </button>
        <a href="/salidas" class="btn btn-secundario">Cancelar</a>
      </div>
    </form>
  </main>

  <!-- Exponer datos al JS (sin lógica) -->
  <script>
    // Datos de la salida actual para que el JS calcule stock máximo cuando editas
    window.SALIDA = {
      Producto: "<%= salida.Producto || '' %>",
      Lote: "<%= salida.Lote || '' %>",
      CantidadOriginal: <%= Number(salida.Cantidad || 0) %>
    };

    // Lotes disponibles enviados por el servidor
    // Formato esperado: [{ Producto, Lote, Caducidad, Stock }, ...]
    window.LOTES = <%- JSON.stringify(lotes || []) %>;
  </script>

  <!-- Ordenamiento dinámico de productos -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const selectProd = document.getElementById('Producto');
      const btnClave   = document.getElementById('ordenClaveProd');
      const btnNombre = document.getElementById('ordenNombreProd');

      if (!selectProd || !btnClave || !btnNombre) return;

      const opcionesOriginales = Array.from(selectProd.querySelectorAll('option'));
      let ascClave = true;

      btnClave.addEventListener('click', function () {
        const opciones = opcionesOriginales.slice(1);
        opciones.sort((a, b) => {
          const ca = (a.dataset.clave || '').toString();
          const cb = (b.dataset.clave || '').toString();
          return ascClave
            ? ca.localeCompare(cb, 'es', { numeric: true })
            : cb.localeCompare(ca, 'es', { numeric: true });
        });
        ascClave = !ascClave;
        actualizarSelect(opciones);
      });

      btnNombre.addEventListener('click', function () {
        const opciones = opcionesOriginales.slice(1);
        opciones.sort((a, b) =>
          (a.dataset.nombre || '').localeCompare(b.dataset.nombre || '', 'es')
        );
        actualizarSelect(opciones);
      });

      function actualizarSelect(listaOpciones) {
        const valorActual = selectProd.value;
        selectProd.innerHTML = '';
        selectProd.appendChild(opcionesOriginales[0]);
        listaOpciones.forEach(opt => selectProd.appendChild(opt));
        selectProd.value = valorActual;
        // cuando cambie el orden, recargamos lotes para ese producto
        rellenarLotes();
      }
    });
  </script>

  <!-- Llenado de LOTES y mensaje de stock (reemplaza a form_salida.js) -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const selectProd = document.getElementById('Producto');
      const selectLote = document.getElementById('Lote');
      const ayuda      = document.getElementById('ayuda-stock');

      const lotes   = Array.isArray(window.LOTES) ? window.LOTES : [];
      const salida  = window.SALIDA || { Producto: '', Lote: '', CantidadOriginal: 0 };

      function rellenarLotes() {
        const codigo = selectProd.value;
        selectLote.innerHTML = '<option value="">-- Selecciona un lote --</option>';
        ayuda.textContent = '';

        if (!codigo) return;

        const lista = lotes.filter(l =>
          String(l.Producto) === String(codigo)
        );

        lista.forEach(l => {
          const opt = document.createElement('option');
          opt.value = l.Lote;
          const cad = l.Caducidad ? String(l.Caducidad).substring(0,10) : '';
          opt.textContent = `${l.Lote} (Stock: ${l.Stock}, Cad: ${cad})`;

          if (
            salida.Lote &&
            String(salida.Producto) === String(codigo) &&
            String(salida.Lote) === String(l.Lote)
          ) {
            opt.selected = true;
          }

          selectLote.appendChild(opt);
        });

        mostrarStock();
      }

      function mostrarStock() {
        const codigo = selectProd.value;
        const lote   = selectLote.value;

        if (!codigo || !lote) {
          ayuda.textContent = '';
          return;
        }

        const item = lotes.find(l =>
          String(l.Producto) === String(codigo) &&
          String(l.Lote)     === String(lote)
        );

        if (!item) {
          ayuda.textContent = '';
          return;
        }

        const base      = Number(item.Stock || 0);
        const mismoProd = String(codigo) === String(salida.Producto || '');
        const mismoLote = String(lote)   === String(salida.Lote || '');
        const max       = (mismoProd && mismoLote)
                          ? base + Number(salida.CantidadOriginal || 0)
                          : base;

        ayuda.textContent = 'Stock disponible para esta operación: ' + max + ' unidades';
      }

      if (selectProd) {
        selectProd.addEventListener('change', rellenarLotes);
      }
      if (selectLote) {
        selectLote.addEventListener('change', mostrarStock);
      }

      // Inicializar al cargar la página
      if (selectProd.value) {
        rellenarLotes();
      }
    });
  </script>
</body>
</html>
