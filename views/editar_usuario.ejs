<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
    <%= editar ? 'Editar Usuario' : 'Nuevo Usuario' %>
  </title>
  <link rel="stylesheet" href="/estilos.css">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>

<body>

  <main class="contenedor" style="max-width:800px;">
    <h2>
      <%= editar ? 'Editar Usuario' : 'Agregar Nuevo Usuario' %>
    </h2>

    <% if (error) { %>
      <p style="color: red; background: #ffecec; padding: 0.5rem 1rem; border-radius: 5px;">
        <%= error %>
      </p>
    <% } %>

    <% 
      // Alias para que no truene si en el controlador se llama "clientes3pl"
      const listaClientes3pl = (typeof clientes3pl !== 'undefined' && clientes3pl) ? clientes3pl : [];
    %>

    <form
      action="<%= editar ? '/usuarios/editar/' + usuarioData.id_usuario : '/usuarios/nuevo' %>"
      method="POST"
      style="display:flex; flex-direction: column; gap: 1rem; background-color: white; padding: 2rem; border-radius: 10px;">

      <label>
        Usuario:
        <input
          type="text"
          name="userName"
          class="input"
          required
          placeholder="Ingresa tu usuario"
          value="<%= usuarioData ? (usuarioData.userName || '') : '' %>">
      </label>

      <label>
        Nombre completo:
        <input
          type="text"
          name="nombreCompleto"
          class="input"
          required
          placeholder="Nombre y apellidos"
          value="<%= usuarioData ? (usuarioData.nombreCompleto || '') : '' %>">
      </label>

      <label>
        Tipo de usuario:
        <select name="tipo_usuario" class="input" required>
          <option value="">Selecciona un tipo</option>

          <option value="administrador"
            <%= usuarioData && usuarioData.tipo_usuario === 'administrador' ? 'selected' : '' %>>
            Administrador
          </option>

          <option value="empleado"
            <%= usuarioData && usuarioData.tipo_usuario === 'empleado' ? 'selected' : '' %>>
            Empleado
          </option>

          <option value="cotizacion"
            <%= usuarioData && usuarioData.tipo_usuario === 'cotizacion' ? 'selected' : '' %>>
            Cotizaci√≥n
          </option>

          <option value="desempleado"
            <%= usuarioData && usuarioData.tipo_usuario === 'desempleado' ? 'selected' : '' %>>
            Desempleado
          </option>

          <option value="cliente"
            <%= usuarioData && usuarioData.tipo_usuario === 'cliente' ? 'selected' : '' %>>
            Cliente
          </option>

          <option value="almacen"
            <%= usuarioData && usuarioData.tipo_usuario === 'almacen' ? 'selected' : '' %>>
            Almac√©n
          </option>

          <option value="facturacion"
            <%= usuarioData && usuarioData.tipo_usuario === 'facturacion' ? 'selected' : '' %>>
            Facturaci√≥n
          </option>

          <option value="recursos_humanos"
            <%= usuarioData && usuarioData.tipo_usuario === 'recursos_humanos' ? 'selected' : '' %>>
            Recursos humanos
          </option>
        </select>
      </label>

      <label>
        Tel√©fono:
        <input
          type="text"
          name="telefono_usuario"
          class="input"
          maxlength="10"
          required
          placeholder="Tel√©fono"
          value="<%= usuarioData ? (usuarioData.telefono_usuario || '') : '' %>">
      </label>

      <label>
        Correo:
        <input
          type="email"
          name="correo_usuario"
          class="input"
          required
          placeholder="Correo electr√≥nico"
          value="<%= usuarioData ? (usuarioData.correo_usuario || '') : '' %>">
      </label>

      <label>
        Contrase√±a:
        <input
          type="password"
          name="contrase√±a_usuario"
          class="input"
          placeholder="Contrase√±a"
          <%= editar ? '' : 'required' %>>
      </label>

      <!-- üëá Asociaci√≥n opcional a Cliente 3PL (solo aplica si el tipo de usuario es "cliente") -->
      <label>
        Cliente 3PL asociado (solo para usuarios tipo "cliente"):
        <select name="id_cliente" class="input">
          <option value="">-- Sin cliente asociado --</option>
          <% (listaClientes3pl || []).forEach(function(c) { %>
            <option
              value="<%= c.id_cliente %>"
              <%= (usuarioData && usuarioData.id_cliente && String(usuarioData.id_cliente) === String(c.id_cliente))
                    ? 'selected' : '' %>>
              <%= c.nombre_cliente %>
            </option>
          <% }); %>
        </select>
      </label>

      <div style="display:flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
        <button type="submit" class="btn btn-exito">
          <%= editar ? 'Actualizar Usuario' : 'A√±adir Usuario' %>
        </button>

        <a href="/usuarios" class="btn btn-secundario">Cancelar</a>
      </div>

    </form>
  </main>

</body>
</html>
