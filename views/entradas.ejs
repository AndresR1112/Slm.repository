<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Entradas</title>
  <link rel="stylesheet" href="/estilos.css" />
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>

<body>

  <% function formatoMX(num) { const n=Number(num); if (isNaN(n)) return num; return n.toLocaleString('es-MX', {
    minimumFractionDigits: 2, maximumFractionDigits: 2 }); } const tipo=usuario ? usuario.tipo_usuario : null; const
    esAdmin=(tipo==='administrador' ); const esEmpleado=(tipo==='empleado' ); const esAlmacen=(tipo==='almacen' ); const
    esRH=(tipo==='recursos_humanos' ); const esFact=(tipo==='facturacion' ); const esCliente=(tipo==='cliente' ); const
    esDesempleado=(tipo==='desempleado' ); const esCotizacion=(tipo==='cotizacion' ); const puedeEditarEntradas=esAdmin
    || esAlmacen; const puedeArchivosEntrada=esAdmin || esAlmacen; const puedeAccionesEntradas=puedeEditarEntradas ||
    puedeArchivosEntrada; %>

    <main style="padding: 2rem; max-width: 2000px; margin:auto;"></main>

    <!-- NAVBAR -->
    <div class="nav">
      <a href="/catalogo">Catálogo</a>

      <% if (!esCliente && !esDesempleado) { %>
        <a href="/entradas" class="active">Entradas</a>
        <a href="/inventario">Inventario</a>
        <a href="/salidas">Salidas</a>
        <a href="/clientes">Clientes</a>
        <a href="/cotizaciones">Cotizaciones</a>
        <% } else if (esCliente) { %>
          <a href="/inventario">Inventario</a>
          <% } %>

            <% if (esAdmin || esFact) { %>
              <a href="/facturacion">Facturación</a>
              <% } %>

                <% if (esAdmin || esRH) { %>
                  <a href="/usuarios">Usuarios</a>
                  <% } %>
    </div>

    <main class="contenedor">
      <h2>Entradas de Producto</h2>

      <!-- Buscador -->
      <form action="/entradas/buscar" method="GET" style="margin-bottom: 1rem;">
        <label for="q">Buscar por Proveedor, Lote, Nombre, Clave o Clave SSA:</label>

        <input type="text" name="q" id="q" required placeholder="Ej: IMSS, Lote123, Paracetamol, 010.000.2154.01, 35915"
          value="<%= typeof q !== 'undefined' ? q : '' %>">

        <button type="submit" class="btn btn-secundario">Buscar</button>
        <a href="/entradas" class="btn btn-exito">Mostrar todas</a>
      </form>

      <!-- Botones de acciones -->
      <div style="margin-bottom: 1rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
        <% if (puedeEditarEntradas) { %>
          <a href="/entradas/nueva" class="btn btn-exito">Nueva Entrada</a>
          <% } %>
            <a href="/entradas/exportar" class="btn btn3">Exportar entradas a Excel</a>
      </div>

      <table>
        <thead>
          <tr>
            <th>Fecha de entrada</th>
            <th>Proveedor</th>
            <th>Nombre del Producto</th>
            <th>Lote</th>
            <th>Caducidad</th>
            <th>Cantidad de entrada</th>
            <th>Costo Total</th>
            <th>Acciones</th>
          </tr>
        </thead>

        <tbody>
          <% if (!entrada || entrada.length===0) { %>
            <tr>
              <td colspan="8" style="text-align:center; opacity:.7;">Sin resultados</td>
            </tr>
            <% } else { %>
              <% entrada.forEach(ent=> {
                const es3PL = !!ent.id_cliente_propietario; // si tiene propietario, se pinta
                const rowClass = es3PL ? 'fila-3pl' : '';
                %>
                <tr class="<%= rowClass %>">
                  <td>
                    <%= new Date(ent.fechaDeEntrada).toLocaleDateString('es-MX') %>
                  </td>
                  <td>
                    <%= ent.proveedor %>
                  </td>
                  <td>
                    <%= ent.ProductoNombre %>
                      <% if (es3PL) { %>
                        <span class="badge-3pl">3PL</span>
                        <% } %>
                  </td>
                  <td>
                    <%= ent.lote %>
                  </td>
                  <td>
                    <%= new Date(ent.caducidad).toLocaleDateString('es-MX') %>
                  </td>
                  <td>
                    <%= formatoMX(ent.cantidad) %>
                  </td>
                  <td>$<%= formatoMX(ent.costoTotal_entrada) %>
                  </td>

                  <td class="col-acciones">
                    <% if (puedeAccionesEntradas) { %>
                      <% const adj=(typeof adjuntosPorEntrada !=='undefined' && adjuntosPorEntrada[ent.id_entrada]) ?
                        adjuntosPorEntrada[ent.id_entrada] : []; const headerTexto=[ new
                        Date(ent.fechaDeEntrada).toLocaleDateString('es-MX'), ent.proveedor, ent.ProductoNombre, 'Lote '
                        + ent.lote ].join(', ');
                  %>

                  <% if (puedeEditarEntradas) { %>
                    <a href="/entradas/editar/<%= ent.id_entrada %>" class="btn btn-secundario">Editar</a>
                  <% } %>

                  <% if (puedeArchivosEntrada) { %>
                    <button
                      type="button"
                      class="btn btn3 btn-archivos"
                      data-id="<%= ent.id_entrada %>"
                      data-header="<%= headerTexto %>"
                      onclick="abrirAdjuntos(<%= ent.id_entrada %>)">
                      Archivos<%= adj.length > 0 ? ' (' + adj.length + ')' : '' %>
                        </button>

                        <div id="archivos-template-<%= ent.id_entrada %>" class="archivos-template"
                          style="display:none;">

                          <% if (adj.length===0) { %>
                            <p class="archivos-vacio">No hay archivos adjuntos.</p>
                            <% } else { %>
                              <ul class="archivos-lista">
                                <% adj.forEach(a=> { %>
                                  <li class="archivos-item">
                                    <a href="/adjuntos/descargar/<%= a.id_archivo %>" class="archivo-nombre"
                                      title="<%= a.nombre_original %>">
                                      <%= a.nombre_original %>
                                    </a>

                                    <form action="/adjuntos/eliminar/<%= a.id_archivo %>" method="POST"
                                      class="form-borrar-adjunto" onsubmit="return confirm('¿Eliminar este archivo?');">
                                      <button type="submit" class="btn-borrar-adjunto">Eliminar</button>
                                    </form>
                                  </li>
                                  <% }) %>
                              </ul>
                              <% } %>

                                <form action="/adjuntos/subir/entradas/<%= ent.id_entrada %>" method="POST"
                                  enctype="multipart/form-data" class="form-adjuntos-menu">
                                  <label>Agregar archivos (PDF):</label>
                                  <input type="file" name="archivos" multiple accept="application/pdf">
                                  <button type="submit" class="btn btn-sm">Subir</button>
                                </form>

                        </div>
                        <% } %>
                          <% } else { %>
                            <span style="color: gray; font-size: 0.85rem;">Sin permisos</span>
                            <% } %>
                  </td>
                </tr>
                <% }); %>
                  <% } %>
        </tbody>
      </table>
    </main>

    <a href="/logout" class="btn-logout">Cerrar sesión</a>

    <!-- PANEL ADJUNTOS -->
    <div id="adjuntosOverlay" class="adj-overlay">
      <div class="adj-panel">
        <div class="adj-header">
          <h3 id="adj-header-text">Archivos</h3>
          <button type="button" class="adj-close" onclick="cerrarAdjuntos()">✖</button>
        </div>
        <div id="adj-body" class="adj-body"></div>
      </div>
    </div>

    <script>
      function abrirAdjuntos(id) {
        const tpl = document.getElementById('archivos-template-' + id);
        if (!tpl) return;

        const overlay = document.getElementById('adjuntosOverlay');
        const headerEl = document.getElementById('adj-header-text');
        const bodyEl = document.getElementById('adj-body');

        const btn = document.querySelector('.btn-archivos[data-id="' + id + '"]');
        if (btn && btn.dataset.header) {
          headerEl.textContent = btn.dataset.header;
        } else {
          headerEl.textContent = 'Archivos';
        }

        bodyEl.innerHTML = tpl.innerHTML;
        overlay.classList.add('activo');
      }

      function cerrarAdjuntos() {
        const overlay = document.getElementById('adjuntosOverlay');
        if (overlay) overlay.classList.remove('activo');
      }

      document.addEventListener('click', function (e) {
        const overlay = document.getElementById('adjuntosOverlay');
        if (!overlay || !overlay.classList.contains('activo')) return;

        const dentroPanel = e.target.closest('.adj-panel');
        const pulsandoBoton = e.target.closest('.btn-archivos');
        if (!dentroPanel && !pulsandoBoton) {
          cerrarAdjuntos();
        }
      });
    </script>

</body>

</html>